<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8"/>

    <title>Proteus Activity</title>

    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="js/jquery/2.0.3/jquery.min.js"></script>
    <script src="js/lodash/2.4.1/lodash.min.js"></script>

    <script src="js/socket.io.js"></script>
    <script src="js/util.js"></script>
    <script src="js/logging.js"></script>
    <script src="js/API.js"></script>
    <script src="js/render.js"></script>
    <script src="js/internetArchive.js"></script>
    <link rel="stylesheet" href="css/activity.css" type="text/css"/>

    <script>
        var msgArr = [];

        function showHideActivity(that, type) {

            if (that.checked == true) {
                showMsg(type)
            } else {
                hideMsg(type)
            }

        }

        function hideMsg(type) {
          $(".activity-" + type).hide()
        }

        function toggleAll(that){

            _.each(msgArr, function(m){
                var el = $('input:checkbox.broadcast-msg-' + m)[0];
                if (!_.isUndefined(el)) {
                    el.checked = that.checked;
                    showHideActivity(that, m)
                }
            })

        }

        function  hideMsgs(){

            _.each(msgArr, function(m){

                var el = $('input:checkbox.broadcast-msg-' + m)[0];
                if (!_.isUndefined(el)) {
                    var checked = el.checked;
                    if (!checked) {
                        hideMsg(m)
                    }
                }
            });
        }
        function showMsg(type) {

            $(".activity-" + type).show()

        }

        function showHideUser(){

            var txt = $("#filter-user")[0].value;
            if (txt.length == 0){
                $(".activity-row").show()
            } else {
                $(".activity-row").hide();
                $('[class*="user-' + txt + '"]').show()
            }
            hideMsgs()
        }
        $(document).ready(function () {

            // make sure we're logged in
            if (isLoggedIn() == false) {
                document.write('<a href="index.html">Please log in first</a>');
                return;
            }

            var args = {};
            API.getActivityLog(args,
                    function(args){
                      //console.log(args)
                      args.events.split(/\r\n|\r|\n/).forEach(function(line){
                          if (!_.isUndefined(line) && line.trim().length > 0)
                            output(convertJSONtoHTML(line));

                      })
                    },
                    function(req, status, err) {
                        alert("ERROR: ``" + err + "``");
                        throw err;
                    });


            if (!_.isUndefined(localStorage["messages"])) {
                var html = '';

                var msgs = JSON.parse(localStorage["messages"]);
                for (msg in msgs) {

                    msgArr.push(msgs[msg].toLowerCase());

                    html += '<input onclick="showHideActivity(this, \'' + msgs[msg] + '\');" class="broadcast-msg-' + msgs[msg] + '" ' +
                    'type="checkbox" name="messages" value="' + msgs[msg] + '" checked /> ' + msgs[msg] + '&nbsp;';
                }

                html += '<input onclick="toggleAll(this);" type="checkbox" name="messages" value="toggle_all" checked />ALL&nbsp;';
                html += ' | Filter by user: <input id="filter-user" type="text"  >';
                $("#broadcast-chioces").html(html);
                $("#filter-user").keyup(function(){
                    showHideUser()
                });
            }

            var data = getCookie("broadcast");
            if (_.isUndefined(data)) {
                document.write('missing connection information.');
                return;
            }
            var jsonData = JSON.parse(data);

            var port = jsonData.port;

            // if there is a port on the URL, we'll override the port stored locally, because
            // we may be in one browser but want to look at multiple activity streams. Since it's
            // stored at the cookie level, we can only have one per browser
            var urlParams = getURLParams();

            if (_.isUndefined(urlParams.port) == false){
                port = urlParams.port;
            }
            var host = jsonData.url;

            var socket = io.connect(host + ':' + port);

            socket.on('connect', function () {
                output('<span class="connect-msg">Client has connected to the server!</span>');
            });

            socket.on('ProteusEvent', function (data) {

                var msg = convertJSONtoHTML(data.message);
                output(msg);

                // check if we're displaying this type of message
                showHideUser();
                hideMsgs();

            });

            socket.on('disconnect', function () {
                output('<span class="disconnect-msg">The client has disconnected!</span>');
            });

            function sendDisconnect() {
                socket.disconnect();
            }

            function output(message) {

                var element = $("<div>" + message + "</div>");
                $('#activity').prepend(element);
            }

        });
    </script>
</head>

<body id="activity-body">
<nav id="activity-header" class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid ">
        <div id="broadcast-chioces" class="row clearfix">

        </div>
    </div>
</nav>

<div id="activity" class="row clearfix">

</div>

</body>

</html>
